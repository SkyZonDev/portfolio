#!/bin/bash
# .husky/pre-commit

echo "üîç V√©rification pre-commit..."

# Fonction pour v√©rifier si des fichiers de code source ont √©t√© modifi√©s
check_source_files_changed() {
    # R√©cup√©rer les fichiers modifi√©s (staged)
    local changed_files=$(git diff --cached --name-only)

    # V√©rifier s'il y a des fichiers de code source
    echo "$changed_files" | grep -E '\.(ts|tsx|js|jsx)$' > /dev/null
    return $?
}

# Fonction pour v√©rifier si des fichiers de configuration ont √©t√© modifi√©s
check_config_files_changed() {
    local changed_files=$(git diff --cached --name-only)

    # V√©rifier s'il y a des fichiers de configuration qui affectent le linting/formatting
    echo "$changed_files" | grep -E '\.(json|js|ts)$' | grep -E '(tsconfig\.json|eslint\.config|prettier\.config)' > /dev/null
    return $?
}

# Fonction pour v√©rifier si package.json seul a √©t√© modifi√©
check_only_package_json_changed() {
    local changed_files=$(git diff --cached --name-only)
    local file_count=$(echo "$changed_files" | wc -l)

    # Si un seul fichier modifi√© et c'est package.json
    if [ "$file_count" -eq 1 ] && echo "$changed_files" | grep -q "package\.json"; then
        return 0
    fi
    return 1
}

# V√©rifier si seulement package.json a √©t√© modifi√©
if check_only_package_json_changed; then
    echo "‚ÑπÔ∏è  Seul package.json modifi√©. Pre-commit ignor√© (pas de v√©rification de code n√©cessaire)."
    echo "‚úÖ Pre-commit valid√© !"
    exit 0
fi

# V√©rifier si des fichiers de code source ou de configuration ont √©t√© modifi√©s
if ! check_source_files_changed && ! check_config_files_changed; then
    echo "‚ÑπÔ∏è  Aucun fichier de code source modifi√©. Pre-commit ignor√©."
    echo "‚úÖ Pre-commit valid√© !"
    exit 0
fi

echo "üìÅ Fichiers de code source d√©tect√©s. Lancement des v√©rifications..."

# Lancer uniquement le lint
if [ -f "package.json" ]; then
    echo "üßπ Lancement du lint..."
    pnpm lint
    if [ $? -ne 0 ]; then
        echo "‚ùå Linting √©chou√©. Commit annul√©."
        exit 1
    fi
fi

# V√©rifier les types TypeScript
if [ -f "tsconfig.json" ]; then
    echo "üìù V√©rification des types TypeScript..."
    pnpm typecheck
    if [ $? -ne 0 ]; then
        echo "‚ùå Erreurs TypeScript. Commit annul√©."
        exit 1
    fi
fi

echo "‚úÖ Pre-commit valid√© !"
