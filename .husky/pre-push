#!/bin/bash
# .husky/pre-push

echo "ğŸš€ VÃ©rification pre-push..."

# Fonction pour vÃ©rifier si des fichiers de code source ont Ã©tÃ© modifiÃ©s
check_source_files_changed() {
    # RÃ©cupÃ©rer les fichiers modifiÃ©s dans le push
    local changed_files=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only --cached)

    # VÃ©rifier s'il y a des fichiers de code source ou de configuration
    echo "$changed_files" | grep -E '\.(ts|tsx|js|jsx|json|css|scss|sass|md)$' > /dev/null
    return $?
}

# Fonction pour vÃ©rifier si des fichiers critiques ont Ã©tÃ© modifiÃ©s
check_critical_files_changed() {
    local changed_files=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only --cached)

    # VÃ©rifier s'il y a des fichiers critiques qui nÃ©cessitent une build
    # Exclure package.json seul, mais inclure les autres configs importantes
    echo "$changed_files" | grep -E '\.(ts|tsx|js|jsx|css|scss|sass)$' | grep -E '(src/|public/|next\.config|tailwind\.config|postcss\.config|tsconfig\.json)' > /dev/null
    return $?
}

# Fonction pour vÃ©rifier si seulement package.json a Ã©tÃ© modifiÃ©
check_only_package_json_changed() {
    local changed_files=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only --cached)
    local file_count=$(echo "$changed_files" | wc -l)

    # Si un seul fichier modifiÃ© et c'est package.json
    if [ "$file_count" -eq 1 ] && echo "$changed_files" | grep -q "package\.json"; then
        return 0
    fi
    return 1
}

# Fonction pour vÃ©rifier si des changements de dÃ©pendances nÃ©cessitent une build
check_dependency_changes() {
    local changed_files=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only --cached)

    # Si package.json est modifiÃ©, vÃ©rifier s'il y a des changements de dÃ©pendances
    if echo "$changed_files" | grep -q "package\.json"; then
        # VÃ©rifier s'il y a des changements dans les dÃ©pendances (dependencies/devDependencies)
        git diff --cached package.json | grep -E '^[+-].*"(dependencies|devDependencies)"' > /dev/null
        return $?
    fi
    return 1
}

clean_build() {
    echo "ğŸ§¹ Nettoyage du dossier .next..."
    # DÃ©tection de l'environnement d'exÃ©cution et suppression adaptÃ©e
    if command -v rm >/dev/null 2>&1; then
        rm -rf .next
    elif command -v powershell.exe >/dev/null 2>&1; then
        powershell.exe -Command "Remove-Item -Recurse -Force .next"
    elif command -v cmd.exe >/dev/null 2>&1; then
        cmd.exe /C "rmdir /s /q .next"
    else
        echo "âš ï¸ Impossible de nettoyer le dossier .next : commande inconnue."
    fi
}

# VÃ©rifier si seulement package.json a Ã©tÃ© modifiÃ© (sans changements de dÃ©pendances)
if check_only_package_json_changed && ! check_dependency_changes; then
    echo "â„¹ï¸  Seul package.json modifiÃ© (sans changements de dÃ©pendances). Build ignorÃ©e."
    echo "âœ… Pre-push validÃ© !"
    exit 0
fi

# VÃ©rifier si des fichiers nÃ©cessitant une build ont Ã©tÃ© modifiÃ©s
if ! check_critical_files_changed && ! check_dependency_changes; then
    echo "â„¹ï¸  Aucun fichier critique modifiÃ©. Build ignorÃ©e."
    echo "âœ… Pre-push validÃ© !"
    exit 0
fi

echo "ğŸ“ Fichiers critiques dÃ©tectÃ©s. Lancement de la build..."

# VÃ©rifier que tous les tests passent
# if [ -f "package.json" ]; then
#     echo "ğŸ§ª Lancement des tests complets..."
#     pnpm test
#     if [ $? -ne 0 ]; then
#         echo "âŒ Tests Ã©chouÃ©s. Push annulÃ©."
#         exit 1
#     fi
# fi

# VÃ©rifier la build
if [ -f "package.json" ]; then
    echo "ğŸ—ï¸ VÃ©rification de la build..."
    pnpm build
    if [ $? -ne 0 ]; then
        clean_build
        echo "âŒ Build Ã©chouÃ©e. Push annulÃ©."
        exit 1
    fi
    clean_build
fi

echo "âœ… Pre-push validÃ© !"
